name: "Release: Publish tagged version"

on:
  workflow_call:
    inputs:
      sha:
        required: true
        type: string
      ref:
        required: true
        type: string

jobs:
  publish-tagged-release:
    runs-on: "ubuntu-latest"
    steps:
      - name: Check input vars
        run: |
          echo ${{ inputs.ref }}
          echo ${{ inputs.sha }}
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}
      - uses: actions/setup-node@v1
        with:
          node-version: '14'
          registry-url: 'https://npm.pkg.github.com'
      - name: Set name vars
        id: info-vars
        run: |
          echo ::set-output name=sha::${GITHUB_SHA}
          echo ::set-output name=tag::${inputs.ref}
          echo ::set-output name=version::$(echo ${inputs.ref} | cut -c2-)
      - name: Get changelog entry
        id: info-changelog
        uses: mindsers/changelog-reader-action@v2
        #with:
          # version: ${{ steps.tag_name.outputs.current_version }}
      - name: Check name vars
        run: |
          echo ${{ steps.info-vars.outputs.sha }}
          echo ${{ steps.info-vars.outputs.tag }}
          echo ${{ steps.info-vars.outputs.version }}
          echo ${{ steps.info-changelog.outputs.changes }}
      - name: Install dependencies
        run: yarn install
      - name: Compilation test
        run: |
          yarn compile
          yarn compile-scss
      - name: Create jest results
        run: yarn test:generate-output
      # commented out because of chromaui/action bug
      # @see
      # - name: Publish to Chromatic without tests
      #   id: chromatic-upload
      #   uses: chromaui/action@v1
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
      #     exitZeroOnChanges: true
      #     exitOnceUploaded: true
      #     skip: true
      - name: Publish npm package
        run: yarn publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish release
        uses: ncipollo/release-action@v1
        # TODO: add storybook url to body
        # Storybook: ${{ steps.chromatic-upload.outputs.storybookUrl }}
        with:
          tag: ${{ steps.info-vars.outputs.tag }}
          body: |
            NPM package: https://github.com/eccenca/gui-elements/packages/1310639?version=${{ steps.info-vars.outputs.version }}
            ${{ steps.info-changelog.outputs.changes }}
          prerelease: ${{ steps.info-changelog.outputs.status == 'unreleased' }}
          token: ${{ secrets.GITHUB_TOKEN }}
